<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fotbalové tipy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tip-input {
            width: 40px;
        }
        .round-title {
            background-color: #f8f9fa;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .alert {
            display: none;
        }
        .alert-success {
            color: #fff;
            background-color: #28a745;
            border-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Fotbalové tipy</h1>
        
        <!-- Tabulka hráčů je nahoře -->
        <div class="row mb-4">
            <div class="col-md-4">
                <h2>Tabulka</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Hráč</th>
                            <th>Body</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Karlos</td>
                            <td id="karlos-points">0</td>
                        </tr>
                        <tr>
                            <td>Kuba</td>
                            <td id="kuba-points">0</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-warning" onclick="resetPoints()">Reset bodů</button>
            </div>
        </div>

        <!-- Zápasy a tipy -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>Zápasy a tipy</h2>
                <div id="matches-container"></div>
            </div>
        </div>

        <!-- Alert pro úspěšné zadání tipu nebo vyhodnocení -->
        <div id="alert-container" class="alert alert-success"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyDBypohkLROUpKqN1SQpdt-HK_0yt3FzoU",
            authDomain: "fotbaliada.firebaseapp.com",
            projectId: "fotbaliada",
            storageBucket: "fotbaliada.appspot.com",
            messagingSenderId: "164879470554",
            appId: "1:164879470554:web:e9883b553be2ff728b3ae3",
            databaseURL: "https://fotbaliada-default-rtdb.europe-west1.firebasedatabase.app/"
        };

        // Inicializace Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Funkce pro načtení zápasů ze souboru
        async function loadMatches() {
            const response = await fetch('matches.txt');
            const text = await response.text();
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            let currentRound = '';
            let matches = [];
            let rounds = [];

            lines.forEach(line => {
                if (line.includes('. KOLO')) {
                    if (currentRound !== '') {
                        rounds.push({ round: currentRound, matches: matches });
                    }
                    currentRound = line.trim();
                    matches = [];
                } else {
                    matches.push(line.trim());
                }
            });

            if (matches.length > 0) {
                rounds.push({ round: currentRound, matches: matches });
            }

            return rounds;
        }

        // Funkce pro vykreslení zápasů a formulářů pro tipy
        async function renderMatches() {
            const rounds = await loadMatches();
            const evaluatedRoundsSnapshot = await database.ref('evaluatedRounds').once('value');
            const evaluatedRounds = evaluatedRoundsSnapshot.val() || {};

            const container = document.getElementById('matches-container');
            rounds.forEach((round, roundIndex) => {
                // Pokud je kolo již vyhodnoceno, nepřidá se do stránky
                if (evaluatedRounds[roundIndex]) {
                    return;
                }

                const roundElement = document.createElement('div');
                roundElement.className = 'round';
                roundElement.id = `round-${roundIndex}`;
                roundElement.innerHTML = `<h3 class="round-title">${round.round}</h3>`;
                
                round.matches.forEach((match, matchIndex) => {
                    const matchElement = document.createElement('div');
                    matchElement.className = 'mb-3';
                    matchElement.innerHTML = `
                        <h4>${match}</h4>
                        <div class="mb-2">
                            <label>Karlos: </label>
                            <input type="number" class="tip-input" id="karlos-tip-${roundIndex}-${matchIndex}" min="0" max="2" onchange="saveTip('karlos', ${roundIndex}, ${matchIndex}, this.value)">
                            <button class="btn btn-success btn-sm" onclick="evaluateTip('karlos', ${roundIndex}, ${matchIndex}, true)">ANO</button>
                            <button class="btn btn-danger btn-sm" onclick="evaluateTip('karlos', ${roundIndex}, ${matchIndex}, false)">NE</button>
                        </div>
                        <div class="mb-2">
                            <label>Kuba: </label>
                            <input type="number" class="tip-input" id="kuba-tip-${roundIndex}-${matchIndex}" min="0" max="2" onchange="saveTip('kuba', ${roundIndex}, ${matchIndex}, this.value)">
                            <button class="btn btn-success btn-sm" onclick="evaluateTip('kuba', ${roundIndex}, ${matchIndex}, true)">ANO</button>
                            <button class="btn btn-danger btn-sm" onclick="evaluateTip('kuba', ${roundIndex}, ${matchIndex}, false)">NE</button>
                        </div>
                    `;
                    roundElement.appendChild(matchElement);
                });

                // Přidání tlačítka "VYHODNOCENO"
                const evaluateButton = document.createElement('button');
                evaluateButton.className = 'btn btn-warning mt-2';
                evaluateButton.textContent = 'VYHODNOCENO';
                evaluateButton.onclick = () => evaluateRound(roundIndex);
                roundElement.appendChild(evaluateButton);

                container.appendChild(roundElement);
            });

            // Načíst a vyplnit dříve uložené tipy po načtení stránky
            database.ref('tips').once('value').then((snapshot) => {
                const tips = snapshot.val();
                if (tips) {
                    for (const player in tips) {
                        for (const roundIndex in tips[player]) {
                            for (const matchIndex in tips[player][roundIndex]) {
                                const tipInput = document.getElementById(`${player}-tip-${roundIndex}-${matchIndex}`);
                                if (tipInput) {
                                    tipInput.value = tips[player][roundIndex][matchIndex];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funkce pro uložení tipu do Firebase a zobrazení upozornění
        function saveTip(player, roundIndex, matchIndex, tip) {
            database.ref(`tips/${player}/${roundIndex}/${matchIndex}`).set(tip)
                .then(() => {
                    showAlert('Tip zadán');
                })
                .catch((error) => {
                    console.error('Chyba při ukládání tipu:', error);
                });
        }

        // Funkce pro vyhodnocení tipu a zobrazení upozornění
        function evaluateTip(player, roundIndex, matchIndex, isCorrect) {
            if (isCorrect) {
                updatePoints(player, 3);
            }

            // Uložení výsledku do Firebase
            database.ref(`results/${player}/${roundIndex}/${matchIndex}`).set(isCorrect)
                .then(() => {
                    showAlert('Tip vyhodnocen');
                })
                .catch((error) => {
                    console.error('Chyba při vyhodnocení tipu:', error);
                });
        }

        // Funkce pro zobrazení upozornění
        function showAlert(message) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.textContent = message;
            alertContainer.style.display = 'block';
            setTimeout(() => {
                alertContainer.style.display = 'none';
            }, 2000);
        }

        // Funkce pro vyhodnocení a odstranění kola
        function evaluateRound(roundIndex) {
            database.ref(`evaluatedRounds/${roundIndex}`).set(true)
                .then(() => {
                    const roundElement = document.getElementById(`round-${roundIndex}`);
                    if (roundElement) {
                        roundElement.remove();
                    }
                    showAlert('Kolo vyhodnoceno');
                })
                .catch((error) => {
                    console.error('Chyba při vyhodnocení kola:', error);
                });
        }

        // Funkce pro reset bodů
        function resetPoints() {
            database.ref('points').set({
                karlos: 0,
                kuba: 0
            });
            document.getElementById('karlos-points').textContent = '0';
            document.getElementById('kuba-points').textContent = '0';
        }

        // Inicializace aplikace
        async function init() {
            renderMatches();

            // Načtení bodů z Firebase
            database.ref('points').on('value', (snapshot) => {
                const points = snapshot.val();
                if (points) {
                    document.getElementById('karlos-points').textContent = points.karlos || 0;
                    document.getElementById('kuba-points').textContent = points.kuba || 0;
                }
            });
        }

        init();
    </script>
</body>
</html>
